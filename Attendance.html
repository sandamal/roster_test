<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Attendance - Roster Manager</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

<style>
body { font-family:Segoe UI, Arial; margin:0; background:#f4f9fc; }
header { background:#007acc; color:#fff; padding:12px; font-weight:700; text-align:center; }
.wrap { max-width:480px; margin:12px auto; background:#fff; padding:12px; border-radius:10px; }
.controls { display:flex; gap:6px; margin-bottom:10px; }
button { background:#007acc; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
button.active { background:#005f9e; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { padding:8px; border-bottom:1px solid #ddd; text-align:center; }
th { background:#abd6de; font-weight:700; }
.no-data { text-align:center; color:#777; padding:12px; }
.user-info { margin-bottom:10px; font-size:14px; }
</style>
</head>
<body>

<header>Attendance - Roster Manager</header>

<div class="wrap">

  <!-- User Info -->
  <div class="user-info" id="userInfo"></div>

  <!-- Date Controls -->
  <div class="controls">
    <button onclick="changeDay(-1)">â—€ Prev</button>
    <input type="date" id="attDate">
    <button onclick="changeDay(1)">Next â–¶</button>
  </div>

  <!-- Mode toggle -->
  <div class="controls">
    <button id="b6" class="active" onclick="setMode('6h')">6 Hours</button>
    <button id="b8" onclick="setMode('8h')">8 Hours</button>
  </div>

  <!-- Attendance Table -->
  <div id="attTable"></div>

</div>

<script>
/* ðŸ”¥ Firebase Init */
firebase.initializeApp({
  apiKey:"AIzaSyANN1IPnC6vODqIWiOpZgWutnP-LlmH48s",
 authDomain:"gelanigama-roster-team-a.firebaseapp.com",
 projectId:"gelanigama-roster-team-a"
});
const db = firebase.firestore();

/* ---------------- State ---------------- */
let currentDate = new Date();
let currentMode = "6h";

/* Simulate logged-in user details */
let currentUser = {
  name: "John D.",
  pf: "PF123",
  team: "team2Roster",
  tellerId: "171",
  basicSalary: 60000
};

/* ---------------- UI Setup ---------------- */
document.getElementById('attDate').value = currentDate.toISOString().split('T')[0];
document.getElementById('userInfo').innerHTML = `
Name: ${currentUser.name} | PF: ${currentUser.pf} | Team: ${currentUser.team} | Basic Salary: ${currentUser.basicSalary}
`;

function setMode(mode){
  currentMode = mode;
  b6.classList.toggle('active', mode==='6h');
  b8.classList.toggle('active', mode==='8h');
  loadAttendance();
}

function changeDay(offset){
  currentDate.setDate(currentDate.getDate()+offset);
  attDate.value = currentDate.toISOString().split('T')[0];
  loadAttendance();
}

attDate.onchange = e => {
  currentDate = new Date(e.target.value);
  loadAttendance();
};

/* ---------------- Fetch Daily Roster ---------------- */
async function getDailyRoster(dateStr, tellerId, mode){
  const teams = ["team1Roster","team2Roster","team3Roster"];
  for(const team of teams){
    const doc = await db.collection(team).doc(dateStr).get();
    if(!doc.exists) continue;
    const data = doc.data();
    if(data.offDay) continue;
    const tellers = data.tellers||[];
    for(const t of tellers){
      if(t.teller === tellerId){
        const booth = mode==="8h" ? t.booth8||t.booth6 : t.booth6;
        return { team, shift:t.shift, booth: booth||"-" };
      }
    }
  }
  return null;
}

/* ---------------- Attendance Table ---------------- */
async function loadAttendance(){
  const dateStr = currentDate.toISOString().split('T')[0];
  attTable.innerHTML = "Loading...";
  
  const roster = await getDailyRoster(dateStr, currentUser.tellerId, currentMode);
  if(!roster){
    attTable.innerHTML = `<div class="no-data">No roster for ${dateStr}</div>`;
    return;
  }

  // Default arrival/departure times based on shift
  let defaultArrival = roster.shift==="day" ? "06:30" : "18:30";
  let defaultDeparture = roster.shift==="day" ? "19:30" : "07:30";
  
  // Round arrival to next 15min, departure to last 15min
  defaultArrival = roundUp15(defaultArrival);
  defaultDeparture = roundDown15(defaultDeparture);

  // OT calculation (over 8 hours)
  const otHours = calculateOT(defaultArrival, defaultDeparture);

  // Render Table
  attTable.innerHTML = `
    <table>
      <tr>
        <th>Date</th><th>Shift</th><th>Booth</th><th>Arrival</th><th>Departure</th><th>OT Hours</th>
      </tr>
      <tr>
        <td>${dateStr}</td>
        <td>${roster.shift}</td>
        <td>${roster.booth}</td>
        <td>${defaultArrival}</td>
        <td>${defaultDeparture}</td>
        <td>${otHours}</td>
      </tr>
    </table>
  `;
}

/* ---------------- Utility ---------------- */
function roundUp15(time){
  const [h,m] = time.split(":").map(Number);
  const minutes = Math.ceil(m/15)*15;
  const hr = minutes===60 ? h+1 : h;
  const min = minutes===60 ? 0 : minutes;
  return `${String(hr).padStart(2,"0")}:${String(min).padStart(2,"0")}`;
}
function roundDown15(time){
  const [h,m] = time.split(":").map(Number);
  const minutes = Math.floor(m/15)*15;
  return `${String(h).padStart(2,"0")}:${String(minutes).padStart(2,"0")}`;
}
function calculateOT(arrival, departure){
  const [aH,aM] = arrival.split(":").map(Number);
  const [dH,dM] = departure.split(":").map(Number);
  let totalH = dH - aH + (dM - aM)/60;
  return totalH>8 ? (totalH-8).toFixed(2) : "0.00";
}

/* ---------------- Init ---------------- */
loadAttendance();
</script>

</body>
</html>
